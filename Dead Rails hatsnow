local Players = game:GetService("Players")
local player = Players.LocalPlayer
local runService = game:GetService("RunService")
local StarterGui = game:GetService("StarterGui")
local camera = workspace.CurrentCamera

StarterGui:SetCore("SendNotification", {
    Title = "Hat Snow Hub",
    Text = "NPC Lock + Hitbox Expander",
    Duration = 3
})

-- Tạo GUI
local screenGui = Instance.new("ScreenGui")
screenGui.Name = "HatSnowHub_GUI"
screenGui.Parent = game:GetService("CoreGui")

-- Tạo Frame di chuyển được
local frame = Instance.new("Frame")
frame.Size = UDim2.new(0, 200, 0, 100)
frame.Position = UDim2.new(0.4, 0, 0.2, 0)
frame.BackgroundColor3 = Color3.new(0, 0, 0)
frame.BackgroundTransparency = 0.3
frame.Active = true
frame.Draggable = true
frame.Parent = screenGui

-- Tiêu đề Menu
local title = Instance.new("TextLabel")
title.Size = UDim2.new(1, 0, 0.3, 0)
title.BackgroundTransparency = 1
title.TextColor3 = Color3.new(1, 1, 1)
title.Text = "Hat Snow Hub"
title.Font = Enum.Font.Fantasy
title.TextScaled = true
title.Parent = frame

-- Nút bật/tắt NPC Lock
local npcLockButton = Instance.new("TextButton")
npcLockButton.Size = UDim2.new(1, 0, 0.3, 0)
npcLockButton.Position = UDim2.new(0, 0, 0.3, 0)
npcLockButton.BackgroundColor3 = Color3.new(0.2, 0.2, 0.2)
npcLockButton.TextColor3 = Color3.new(1, 1, 1)
npcLockButton.Text = "NPC Camlock: OFF"
npcLockButton.Parent = frame

-- Nút bật/tắt Hitbox Expander
local hitboxButton = Instance.new("TextButton")
hitboxButton.Size = UDim2.new(1, 0, 0.3, 0)
hitboxButton.Position = UDim2.new(0, 0, 0.6, 0)
hitboxButton.BackgroundColor3 = Color3.new(0.2, 0.2, 0.2)
hitboxButton.TextColor3 = Color3.new(1, 1, 1)
hitboxButton.Text = "NPC Hitbox: OFF"
hitboxButton.Parent = frame

local npcLock = false
local expandHitbox = false
local lastTarget = nil
local toggleLoop

-- Mở rộng hitbox
local function ExpandHitbox(target, enable)
    if target and target:FindFirstChild("HumanoidRootPart") then
        if enable then
            target.HumanoidRootPart.Size = Vector3.new(10, 10, 10)
            target.HumanoidRootPart.Transparency = 0.5
            target.HumanoidRootPart.Color = Color3.new(0, 1, 0) -- Màu xanh lá
        else
            target.HumanoidRootPart.Size = Vector3.new(2, 2, 1) -- Kích thước gốc
            target.HumanoidRootPart.Transparency = 0
            target.HumanoidRootPart.Color = Color3.new(1, 1, 1) -- Trở lại màu bình thường
        end
        target.HumanoidRootPart.CanCollide = false
    end
end

-- Tìm NPC gần nhất
local function getClosestNPC()
    local closestNPC = nil
    local closestDistance = math.huge

    for _, object in ipairs(workspace:GetDescendants()) do
        if object:IsA("Model") then
            local humanoid = object:FindFirstChild("Humanoid") or object:FindFirstChildWhichIsA("Humanoid")
            local hrp = object:FindFirstChild("HumanoidRootPart") or object.PrimaryPart
            if humanoid and hrp and humanoid.Health > 0 and object.Name ~= "Horse" then
                local isPlayer = false
                for _, pl in ipairs(Players:GetPlayers()) do
                    if pl.Character == object then
                        isPlayer = true
                        break
                    end
                end
                if not isPlayer then
                    local distance = (hrp.Position - player.Character.HumanoidRootPart.Position).Magnitude
                    if distance < closestDistance then
                        closestDistance = distance
                        closestNPC = object
                    end
                end
            end
        end
    end

    if expandHitbox and closestNPC then
        ExpandHitbox(closestNPC, true)
    end

    return closestNPC
end

-- Bật/Tắt NPC Lock
npcLockButton.MouseButton1Click:Connect(function()
    npcLock = not npcLock
    if npcLock then
        npcLockButton.Text = "NPC Camlock: ON"
        toggleLoop = runService.RenderStepped:Connect(function()
            local npc = getClosestNPC()
            if npc and npc:FindFirstChild("Humanoid") then
                local npcHumanoid = npc:FindFirstChild("Humanoid")
                if npcHumanoid.Health > 0 then
                    camera.CameraSubject = npcHumanoid
                    lastTarget = npc
                else
                    StarterGui:SetCore("SendNotification", {
                        Title = "Kill NPC",
                        Text = npc.Name,
                        Duration = 0.4
                    })
                    lastTarget = nil
                    if player.Character and player.Character:FindFirstChild("Humanoid") then
                        camera.CameraSubject = player.Character:FindFirstChild("Humanoid")
                    end
                end
            else
                if player.Character and player.Character:FindFirstChild("Humanoid") then
                    camera.CameraSubject = player.Character:FindFirstChild("Humanoid")
                end
                lastTarget = nil
            end
        end)
    else
        npcLockButton.Text = "NPC Camlock: OFF"
        if toggleLoop then
            toggleLoop:Disconnect()
            toggleLoop = nil
        end
        if player.Character and player.Character:FindFirstChild("Humanoid") then
            camera.CameraSubject = player.Character:FindFirstChild("Humanoid")
        end
    end
end)

-- Bật/Tắt Hitbox Expander
hitboxButton.MouseButton1Click:Connect(function()
    expandHitbox = not expandHitbox
    if expandHitbox then
        hitboxButton.Text = "NPC Hitbox: ON"
        local npc = getClosestNPC()
        if npc then ExpandHitbox(npc, true) end
    else
        hitboxButton.Text = "NPC Hitbox: OFF"
        for _, object in ipairs(workspace:GetDescendants()) do
            if object:IsA("Model") and object:FindFirstChild("HumanoidRootPart") then
                ExpandHitbox(object, false)
            end
        end
    end
end)
